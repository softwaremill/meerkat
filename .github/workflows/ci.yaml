name: Pulumi CI/CD with KIND

on:
  workflow_dispatch:

  push:
    branches:
      - main
    # paths-ignore:
    #   - ".github/workflows/ci.yaml"

  pull_request:
    branches:
      - main
    # paths-ignore:
    #   - ".github/workflows/ci.yaml"
      
permissions: write-all

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create a KIND Cluster
      run: |
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.11.1/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind
        kind create cluster

    - name: Install Pulumi
      run: |
        curl -fsSL https://get.pulumi.com | sh
        echo "$HOME/.pulumi/bin" >> $GITHUB_PATH

    - name: Run Pulumi Up
      run: |
        pulumi login --local
        pulumi stack init localstack
      env:
        PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
      working-directory: ./deploy/observability

    - name: Destroy Pulumi Resources
      run: |
        pulumi destroy --yes

    - name: Destroy the KIND Cluster
      if: always()
      run: |
        kind delete cluster
